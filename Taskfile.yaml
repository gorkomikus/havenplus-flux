version: '3'

dotenv: ['.env']

vars:
  KIND_VERSION: 1.32.0
  KIND_CLUSTER_NAME: '{{default "gitops-fluxcd" .KIND_CLUSTER_NAME}}'
  GITLAB_REPO_URL: '{{default "https://gitlab.com/commonground/haven/havenplus/gitops-flux.git" .GITLAB_REPO_URL}}'
  GITLAB_REPO_BRANCH: '{{default "main" .GITLAB_REPO_BRANCH}}'
  PULL_CONTAINER_IMAGES: '{{default "true" .PULL_CONTAINER_IMAGES}}'

tasks:
  default:
    desc: "Help / Show available tasks."
    cmds:
      - task --list-all
    silent: true

  requirements-check:
    desc: "Check whether the user has all the required tools installed locally."
    preconditions:
      - sh: command -v kind
        msg: |
          ðŸš¨ kind is not installed! Use 'asdf' to install it (see README for details)
      - sh: command -v flux
        msg: |
          ðŸš¨ fluxcd (cli) is not installed! Use 'asdf' to install it (see README for details)
      - sh: command -v helm
        msg: |
          ðŸš¨ helm is not installed! Use 'asdf' to install it (see README for details)
      - sh: command -v kubectl
        msg: |
          ðŸš¨ kubectl is not installed! Use 'asdf' to install it (see README for details)
      - sh: command -v cloud-provider-kind
        msg: |
          ðŸš¨ cloud-provider-kind is not installed! See https://github.com/kubernetes-sigs/cloud-provider-kind?tab=readme-ov-file#install for installation instructions
    cmds:
      - echo -e "âœ…  All preconditions have been met."
    silent: true

  run-local:
    desc: "Run a local K8S cluster with all platform-services installed on it."
    deps: [requirements-check]
    cmds:
      - task: pull-container-images
      - task: create-kind-cluster
      - task: load-images-in-kind
      - task: install-fluxcd
      - task: deploy-flux-gitsource
      - task: deploy-flux-bootstrap-kustomization
      - task: boost-reconcilitions
      - task: watch-kustomizations
      - task: output-success-message

  pull-container-images:
    desc: "Pull all container images locally."
    internal: false
    cmds:
      - |
        if [ "{{.PULL_CONTAINER_IMAGES}}" != "true" ]; then 
          echo "â„¹ï¸  Skipping pulling of container images as per configuration."
          exit 0
        fi

        echo "ðŸ› ï¸  Pulling all required container images locally - this can take a while!"
        max_retries=3
        retry_delay=5  # seconds
        failed_images_file="logs/failed_image_pulls.log"
        mkdir -p logs

        # Clear the log file at the start
        echo "The following images have been failed to pull. This might slow down and / or break the start-up of the HavenPlus stack!" > "$failed_images_file"

        for image in $(cat .image-versions); do
          retry_count=0
          success=false

          while [ $retry_count -lt $max_retries ]; do
            if docker pull "$image"; then
              success=true
              break
            else
              retry_count=$((retry_count + 1))
              echo "Failed to pull $image (attempt $retry_count/$max_retries). Retrying in $retry_delay seconds..."
              sleep $retry_delay
            fi
          done

          if ! $success; then
            echo "Failed to pull $image after $max_retries attempts. Logging to $failed_images_file."
            echo "$image" >> "$failed_images_file"
          fi
        done
        echo "âœ…  All container images have been pulled locally."
    silent: true

  create-kind-cluster:
    desc: "Create and start a local Kubernetes cluster with Kind."
    internal: true
    cmds: 
      - |
        kind create cluster --config=- <<EOF
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        name: {{.KIND_CLUSTER_NAME}}
        nodes:
          - role: control-plane
            image: kindest/node:v{{.KIND_VERSION}}
        EOF
      - echo "âœ…  Local Kind cluster created successfully!"
    silent: true

  load-images-in-kind:
    desc: "Create and start a local Kubernetes cluster with Kind."
    internal: true
    cmds:
      - echo "ðŸ› ï¸  Loading container images into Kind cluster - this can take a while!"
      - for i in `cat .image-versions`; do kind load docker-image $i --name gitops-fluxcd; done
      - echo "âœ…  All container images have been loaded into the Kind cluster."
    silent: true

  # We are not using the 'flux bootstrap' command, as this will need a Gitlab Access Token. 
  # Normally, this would be the way to go, so that an SSH key is automatically created and granted 
  # access to the repository. As we are using a public repository and obviously cannot grant write-access
  # to the world, we are doing a manual setup here via the following flux commands. Once the GitSource 
  # and Kustomization are created, Flux will have a reference to the repo and the workloads will be 
  # deployed to the local Kind cluster.
  install-fluxcd:
    desc: "Install FluxCD on the local Kind cluster."
    cmds:
      - echo "ðŸ› ï¸  Installing FluxCD  - this can take while!"
      - flux install
      - echo "âœ…  FluxCD installed successfully on local Kind cluster!"
    silent: true

  deploy-flux-gitsource:
    desc: "Connect FluxCD to the given Git repository by deploying a GitSource to FluxCD."
    cmds:
      - |
        flux create source git flux-system \
          --url={{.GITLAB_REPO_URL}} \
          --branch={{.GITLAB_REPO_BRANCH}}
      - echo "âœ…  Connected FluxCD to repository '{{.GITLAB_REPO_URL}}'"
    silent: true

  deploy-flux-bootstrap-kustomization:
    desc: "Deploy a bootstrap Kustomization for the local Kind cluster."
    cmds:
      - |
        flux create kustomization flux-system \
          --source=GitRepository/flux-system \
          --path=clusters/local/flux-system \
          --prune=true
      - echo "âœ…  Created FluxCD bootstrap configuration!"
      - echo "ðŸ‘‰  HavenPlus workloads will now be deployed to the local Kind cluster."
    silent: true

  watch-kustomizations:
    desc: "Watch all Kustomizations in the local Kind cluster."
    set: [pipefail]
    cmds:
      - echo "ðŸ‘€  Watching Kustomizations - this can take a while!"
      - |
        while true; do
          if ! flux get kustomizations 2>/dev/null | tail -n +2 | awk '$4 != "True" {exit 1}'; then
            echo "âš ï¸  Please be patient, not all Kustomizations are ready: "
            flux get kustomizations | tail -n +2 | awk '$4 != "True"'
            sleep 5
          else
            break
          fi
        done
      - echo "âœ…  All Kustomizations are ready!"
    silent: true
  
  boost-reconcilitions:
    desc: "Boost reconcilitions of all Kustomizations to speed up local deployment."
    cmds:
      - echo "ðŸš€  Boosting reconcilitions of Kustomizations, please stand-by..."
      - |
        for kustomization in cluster-resources kyverno-controller kyverno-policies cloudnative-pg sealed-secrets ; do
          echo "  ðŸ”„  Reconciling Kustomization: $kustomization"
          flux reconcile kustomization $kustomization >/dev/null 2>&1
        done
    silent: true

  output-success-message:
    desc: "Output success message once local Kind cluster is up and running."
    internal: true
    cmds:
      - echo -e "\nðŸš€ðŸš€ðŸš€ LOCAL HAVENPLUS PLATFORM IS UP AND RUNNING ðŸš€ðŸš€ðŸš€\n"
      - echo "ðŸ‘‰  Run the command 'flux get all' to verify the status."
      - echo "ðŸ‘‰  Run the command 'sudo cloud-provider-kind' to expose the Ingress (Service of type LoadBalancer)."
      - echo "ðŸ‘‰  Run the command 'kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}'' to get the local IP address that cloud-provider-kind created."
      - echo "ðŸ‘‰  Edit your /etc/hosts file to map the hostname of an application in your cluster to the local IP address."
    silent: true

  uninstall: 
    desc: "Uninstall local set-up by deleting the Kind cluster."
    cmds:
      - kind delete cluster --name {{.KIND_CLUSTER_NAME}}
      - echo "âœ…  Kind cluster '{{.KIND_CLUSTER_NAME}}' successfully uninstalled."
    silent: true
